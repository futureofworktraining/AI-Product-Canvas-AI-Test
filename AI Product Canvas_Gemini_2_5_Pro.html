<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Product Canvas</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .container {
            max-width: 960px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #6f42c1; /* Purple */
        }
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 2px solid transparent;
        }
        .nav-tabs .nav-link.active {
            color: #6f42c1;
            border-bottom: 2px solid #6f42c1;
            font-weight: bold;
        }
        .section-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #fff;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #495057;
        }
        .section-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            color: #6f42c1; /* Purple header text */
            font-weight: bold;
        }
         .section-header h5 i {
             margin-right: 8px;
             font-size: 1.2em;
         }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .form-control, .form-select {
            border-radius: 0.25rem;
            border: 1px solid #ced4da;
        }
        .form-control:focus, .form-select:focus {
            border-color: #a88cdb; /* Lighter purple focus */
            box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
        }
        .btn-primary {
            background-color: #6f42c1;
            border-color: #6f42c1;
        }
        .btn-primary:hover {
            background-color: #5a37a0;
            border-color: #5a37a0;
        }
         .btn-secondary {
             background-color: #6c757d;
             border-color: #6c757d;
         }
         .btn-secondary:hover {
             background-color: #5a6268;
             border-color: #545b62;
         }
        .btn-suggest {
            background-color: #e9ecef;
            color: #6f42c1;
            border: 1px solid #ced4da;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        .btn-suggest:hover {
            background-color: #ced4da;
        }
        .btn-suggest i {
            margin-right: 3px;
        }
        .api-key-section {
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .action-buttons {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1090;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        label i {
             margin-right: 5px;
        }
        .form-text {
             font-size: 0.8em;
        }
        .required-field::after {
             content: " *";
             color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">AI Product Canvas</h1>

        <!-- API Key Section -->
        <div class="api-key-section row align-items-center gx-2">
            <div class="col-md-7">
                <label for="openai-api-key" class="form-label mb-0">Klucz API OpenAI:</label>
                <input type="password" class="form-control form-control-sm" id="openai-api-key" placeholder="Wprowadź swój klucz API OpenAI">
            </div>
            <div class="col-md-3">
                 <button class="btn btn-secondary btn-sm w-100 mt-3 mt-md-0" id="test-connection-btn">
                    <i class="bi bi-plug"></i> Test połączenia
                </button>
            </div>
             <div class="col-md-2 text-center text-md-start mt-2 mt-md-0">
                <span id="api-status" class="badge bg-secondary">Nie testowano</span>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="canvasTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="definicja-tab" data-bs-toggle="tab" data-bs-target="#definicja-content" type="button" role="tab" aria-controls="definicja-content" aria-selected="true">Definicja Rozwiązania</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="biznes-tab" data-bs-toggle="tab" data-bs-target="#biznes-content" type="button" role="tab" aria-controls="biznes-content" aria-selected="false">Aspekty Biznesowe i Użytkownik</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="technologia-tab" data-bs-toggle="tab" data-bs-target="#technologia-content" type="button" role="tab" aria-controls="technologia-content" aria-selected="false">Aspekty Technologiczne</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="canvasTabsContent">

            <!-- Tab 1: Definicja Rozwiązania -->
            <div class="tab-pane fade show active" id="definicja-content" role="tabpanel" aria-labelledby="definicja-tab">
                <h2 class="mb-4">Podstawowe Informacje o rozwiązaniu</h2>

                <div class="section-card">
                    <div class="section-header">
                        <h5><i class="bi bi-card-heading"></i> Nazwa rozwiązania</h5>
                        <button class="btn btn-suggest btn-sm" data-target="nazwa-rozwiazania" data-label="Nazwa rozwiązania">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="nazwa-rozwiazania" class="form-label required-field">Krótka, zwięzła nazwa projektu AI</label>
                    <input type="text" class="form-control" id="nazwa-rozwiazania" placeholder="Np. Inteligentny Asystent Klienta">
                </div>

                <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-person-fill"></i> Właściciel</h5>
                        <button class="btn btn-suggest btn-sm" data-target="wlasciciel" data-label="Właściciel">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="wlasciciel" class="form-label required-field">Osoba lub dział odpowiedzialny za projekt</label>
                    <input type="text" class="form-control" id="wlasciciel" placeholder="Np. Dział Marketingu">
                </div>

                <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-text-paragraph"></i> Krótki opis rozwiązania</h5>
                         <button class="btn btn-suggest btn-sm" data-target="krotki-opis" data-label="Krótki opis rozwiązania">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="krotki-opis" class="form-label required-field">Zwięzły opis ogólnego celu i funkcjonalności rozwiązania AI</label>
                    <textarea class="form-control" id="krotki-opis" rows="4" placeholder="Aplikacja AI analizująca zapytania klientów i automatycznie kierująca je do odpowiednich działów, w celu skrócenia czasu odpowiedzi i poprawy satysfakcji klienta."></textarea>
                     <div class="form-text">Możesz używać składni markdown (np. **pogrubienie**, *kursywa*)</div>
                </div>
            </div>

            <!-- Tab 2: Aspekty Biznesowe i Użytkownik -->
            <div class="tab-pane fade" id="biznes-content" role="tabpanel" aria-labelledby="biznes-tab">
                <h2 class="mb-4">Problem i wartość biznesowa</h2>
                <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-bullseye"></i> Problem biznesowy i oczekiwane rezultaty</h5>
                         <button class="btn btn-suggest btn-sm" data-target="problem-biznesowy" data-label="Problem biznesowy i oczekiwane rezultaty">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="problem-biznesowy" class="form-label">Szczegółowe opisanie problemu biznesowego, który ma rozwiązać narzędzie AI, oraz oczekiwanych rezultatów</label>
                    <textarea class="form-control" id="problem-biznesowy" rows="4" placeholder="Obecnie czas odpowiedzi na zapytania klientów jest zbyt długi, co negatywnie wpływa na ich satysfakcję. Chcemy zautomatyzować proces kierowania zapytań, skracając czas odpowiedzi i zwiększając efektywność działu obsługi klienta."></textarea>
                </div>

                <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-graph-up-arrow"></i> Wartość biznesowa</h5>
                         <button class="btn btn-suggest btn-sm" data-target="wartosc-biznesowa" data-label="Wartość biznesowa">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="wartosc-biznesowa" class="form-label">Konkretne korzyści biznesowe wynikające z wdrożenia rozwiązania AI</label>
                    <textarea class="form-control" id="wartosc-biznesowa" rows="4" placeholder="Zmniejszenie kosztów operacyjnych działu obsługi klienta o 15%, wzrost satysfakcji klientów mierzony wskaźnikiem NPS o 10 punktów, zwiększenie liczby rozwiązanych spraw w pierwszym kontakcie o 20%."></textarea>
                </div>

                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-exclamation-triangle-fill"></i> Możliwe przeszkody</h5>
                         <button class="btn btn-suggest btn-sm" data-target="mozliwe-przeszkody" data-label="Możliwe przeszkody">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="mozliwe-przeszkody" class="form-label">Potencjalne trudności i wyzwania związane z wdrożeniem</label>
                    <textarea class="form-control" id="mozliwe-przeszkody" rows="3" placeholder="Konieczność integracji z przestarzałymi systemami IT, opór ze strony użytkowników wobec nowych technologii."></textarea>
                </div>

                <h2 class="mb-4 mt-5">Dane</h2>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-database-fill"></i> Dostępność i źródła danych</h5>
                         <button class="btn btn-suggest btn-sm" data-target="dostepnosc-danych" data-label="Dostępność i źródła danych">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="dostepnosc-danych" class="form-label">Jakie dane są potrzebne? Czy są dostępne? Skąd pochodzą?</label>
                    <textarea class="form-control" id="dostepnosc-danych" rows="3" placeholder="Potrzebne są historyczne zapisy zapytań klientów (e-maile, chaty). Dane są dostępne w systemie CRM i archiwum poczty."></textarea>
                </div>

                <h2 class="mb-4 mt-5">Użytkownicy</h2>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-people-fill"></i> Grupy użytkowników i ich potrzeby</h5>
                         <button class="btn btn-suggest btn-sm" data-target="uzytkownicy-potrzeby" data-label="Grupy użytkowników i ich potrzeby">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="uzytkownicy-potrzeby" class="form-label">Kto będzie korzystał z rozwiązania? Jakie są ich główne cele i oczekiwania?</label>
                    <textarea class="form-control" id="uzytkownicy-potrzeby" rows="3" placeholder="Główni użytkownicy to pracownicy działu obsługi klienta. Potrzebują szybkiego dostępu do skategoryzowanych zapytań i sugestii odpowiedzi."></textarea>
                </div>

                 <h2 class="mb-4 mt-5">Działanie rozwiązania i mierniki sukcesu</h2>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-activity"></i> Kluczowe funkcjonalności</h5>
                         <button class="btn btn-suggest btn-sm" data-target="kluczowe-funkcjonalnosci" data-label="Kluczowe funkcjonalności">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="kluczowe-funkcjonalnosci" class="form-label">Jakie zadania będzie wykonywać AI? Jakie są główne funkcje aplikacji?</label>
                    <textarea class="form-control" id="kluczowe-funkcjonalnosci" rows="4" placeholder="1. Automatyczna kategoryzacja przychodzących zapytań. 2. Identyfikacja pilności. 3. Sugerowanie odpowiedniego działu/osoby do obsługi. 4. Generowanie wstępnych sugestii odpowiedzi."></textarea>
                </div>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-clipboard-data-fill"></i> Mierniki sukcesu (KPI)</h5>
                         <button class="btn btn-suggest btn-sm" data-target="mierniki-sukcesu" data-label="Mierniki sukcesu (KPI)">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="mierniki-sukcesu" class="form-label">Jak będziemy mierzyć efektywność rozwiązania?</label>
                    <textarea class="form-control" id="mierniki-sukcesu" rows="3" placeholder="Średni czas odpowiedzi na zapytanie, wskaźnik NPS, % spraw rozwiązanych przy pierwszym kontakcie, dokładność kategoryzacji AI."></textarea>
                </div>
            </div>

             <!-- Tab 3: Aspekty Technologiczne -->
            <div class="tab-pane fade" id="technologia-content" role="tabpanel" aria-labelledby="technologia-tab">
                 <h2 class="mb-4">Dane i modele</h2>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-cpu-fill"></i> Modele AI i techniki</h5>
                         <button class="btn btn-suggest btn-sm" data-target="modele-ai" data-label="Modele AI i techniki">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="modele-ai" class="form-label">Jakie algorytmy/modele AI zostaną użyte (np. NLP, klasyfikacja, regresja)?</label>
                    <textarea class="form-control" id="modele-ai" rows="3" placeholder="Wykorzystanie modeli NLP do analizy tekstu (np. BERT, GPT), klasyfikatorów (np. SVM, Random Forest) do kategoryzacji."></textarea>
                </div>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-clipboard-check-fill"></i> Ocena i walidacja modeli</h5>
                         <button class="btn btn-suggest btn-sm" data-target="ocena-modeli" data-label="Ocena i walidacja modeli">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="ocena-modeli" class="form-label">Jak modele będą trenowane, testowane i oceniane?</label>
                    <textarea class="form-control" id="ocena-modeli" rows="3" placeholder="Podział danych na zbiory treningowy, walidacyjny i testowy. Metryki: accuracy, precision, recall, F1-score. Walidacja krzyżowa."></textarea>
                </div>

                <h2 class="mb-4 mt-5">Infrastruktura i bezpieczeństwo</h2>
                <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-hdd-stack-fill"></i> Infrastruktura</h5>
                         <button class="btn btn-suggest btn-sm" data-target="infrastruktura" data-label="Infrastruktura">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="infrastruktura" class="form-label">Gdzie rozwiązanie będzie hostowane (chmura, on-premise)? Jakie zasoby są potrzebne?</label>
                    <textarea class="form-control" id="infrastruktura" rows="3" placeholder="Hosting w chmurze (np. AWS, Azure, GCP). Potrzebne zasoby: instancje obliczeniowe (CPU/GPU), storage, bazy danych."></textarea>
                </div>
                <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-shield-lock-fill"></i> Bezpieczeństwo i prywatność</h5>
                         <button class="btn btn-suggest btn-sm" data-target="bezpieczenstwo" data-label="Bezpieczeństwo i prywatność">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="bezpieczenstwo" class="form-label">Jakie są wymagania dotyczące bezpieczeństwa danych i zgodności (np. RODO)?</label>
                    <textarea class="form-control" id="bezpieczenstwo" rows="3" placeholder="Szyfrowanie danych w spoczynku i tranzycie. Anonimizacja danych osobowych. Zgodność z RODO. Kontrola dostępu."></textarea>
                </div>

                 <h2 class="mb-4 mt-5">Interfejs użytkownika (UX)</h2>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-display-fill"></i> Interfejs i interakcja</h5>
                         <button class="btn btn-suggest btn-sm" data-target="interfejs-ux" data-label="Interfejs i interakcja">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="interfejs-ux" class="form-label">Jak użytkownicy będą interagować z rozwiązaniem? Jak będzie wyglądał interfejs?</label>
                    <textarea class="form-control" id="interfejs-ux" rows="3" placeholder="Interfejs webowy zintegrowany z istniejącym systemem CRM. Dashboard pokazujący skategoryzowane zapytania i sugestie."></textarea>
                </div>

                 <h2 class="mb-4 mt-5">Rozwój aplikacji</h2>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-code-slash"></i> Zespół i metodologia</h5>
                         <button class="btn btn-suggest btn-sm" data-target="zespol-metodologia" data-label="Zespół i metodologia">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="zespol-metodologia" class="form-label">Kto będzie rozwijał rozwiązanie? Jaka metodologia (np. Agile, Scrum) zostanie użyta?</label>
                    <textarea class="form-control" id="zespol-metodologia" rows="3" placeholder="Wewnętrzny zespół IT (data scientists, backend/frontend developers, UX designer) + konsultanci AI. Metodologia Agile (Scrum)."></textarea>
                </div>
                 <div class="section-card">
                     <div class="section-header">
                        <h5><i class="bi bi-calendar-check-fill"></i> Plan wdrożenia i utrzymania</h5>
                         <button class="btn btn-suggest btn-sm" data-target="plan-wdrozenia" data-label="Plan wdrożenia i utrzymania">
                            <i class="bi bi-lightbulb"></i> Sugestia AI
                        </button>
                    </div>
                    <label for="plan-wdrozenia" class="form-label">Jakie są etapy wdrożenia? Jak rozwiązanie będzie monitorowane i utrzymywane?</label>
                    <textarea class="form-control" id="plan-wdrozenia" rows="3" placeholder="Etapy: MVP, testy pilotażowe, pełne wdrożenie. Monitorowanie wydajności modelu, logów aplikacji. Regularne aktualizacje i retrening modelu."></textarea>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <input type="file" id="load-canvas-input" accept=".json" style="display: none;">
            <button class="btn btn-secondary" id="load-canvas-btn">
                <i class="bi bi-cloud-arrow-up"></i> Wczytaj Kanwę
            </button>
            <button class="btn btn-primary" id="save-canvas-btn">
                <i class="bi bi-cloud-arrow-down"></i> Zapisz Kanwę
            </button>
            <button class="btn btn-primary" id="save-docx-btn">
                <i class="bi bi-file-earmark-word"></i> Zapisz jako DOCX
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
         <!-- Toast template (will be cloned) -->
        <div id="toast-template" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="toast-header">
                <strong class="me-auto toast-title">Powiadomienie</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <!-- Message will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <!-- docx library -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // --- DOM Elements ---
        const apiKeyInput = document.getElementById('openai-api-key');
        const testConnectionBtn = document.getElementById('test-connection-btn');
        const apiStatusSpan = document.getElementById('api-status');
        const saveCanvasBtn = document.getElementById('save-canvas-btn');
        const loadCanvasBtn = document.getElementById('load-canvas-btn');
        const loadCanvasInput = document.getElementById('load-canvas-input');
        const saveDocxBtn = document.getElementById('save-docx-btn');
        const suggestionButtons = document.querySelectorAll('.btn-suggest');
        const toastContainer = document.querySelector('.toast-container');
        const toastTemplate = document.getElementById('toast-template');

        const allInputIds = [
            'nazwa-rozwiazania', 'wlasciciel', 'krotki-opis',
            'problem-biznesowy', 'wartosc-biznesowa', 'mozliwe-przeszkody',
            'dostepnosc-danych', 'uzytkownicy-potrzeby', 'kluczowe-funkcjonalnosci',
            'mierniki-sukcesu', 'modele-ai', 'ocena-modeli', 'infrastruktura',
            'bezpieczenstwo', 'interfejs-ux', 'zespol-metodologia', 'plan-wdrozenia'
        ];

        const requiredFields = ['nazwa-rozwiazania', 'wlasciciel', 'krotki-opis'];

        // --- Toast Notification Function ---
        function showToast(message, type = 'info') { // type: 'info', 'success', 'danger', 'warning'
            const newToast = toastTemplate.cloneNode(true);
            newToast.removeAttribute('id');
            const toastBody = newToast.querySelector('.toast-body');
            const toastTitle = newToast.querySelector('.toast-title');

            toastBody.textContent = message;

            // Remove existing background classes
            newToast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white');
            toastTitle.textContent = 'Powiadomienie'; // Default title

            switch (type) {
                case 'success':
                    newToast.classList.add('bg-success', 'text-white');
                    toastTitle.textContent = 'Sukces';
                    break;
                case 'danger':
                    newToast.classList.add('bg-danger', 'text-white');
                    toastTitle.textContent = 'Błąd';
                    break;
                case 'warning':
                    newToast.classList.add('bg-warning', 'text-dark'); // Dark text for warning bg
                     toastTitle.textContent = 'Ostrzeżenie';
                    break;
                case 'info':
                default:
                    newToast.classList.add('bg-info', 'text-dark'); // Dark text for info bg
                    break;
            }

            toastContainer.appendChild(newToast);
            const toast = new bootstrap.Toast(newToast);
            toast.show();

            // Optional: Remove toast from DOM after hiding
            newToast.addEventListener('hidden.bs.toast', () => {
                newToast.remove();
            });
        }

        // --- Validation ---
        function validateRequiredFields() {
            let isValid = true;
            requiredFields.forEach(id => {
                const element = document.getElementById(id);
                if (!element.value.trim()) {
                    element.classList.add('is-invalid');
                    isValid = false;
                } else {
                    element.classList.remove('is-invalid');
                }
            });
            if (!isValid) {
                 showToast('Proszę wypełnić wszystkie wymagane pola (oznaczone *)', 'warning');
            }
            return isValid;
        }

        // --- Gather Context for AI ---
        function gatherContext() {
            let context = "";
            allInputIds.forEach(id => {
                const element = document.getElementById(id);
                const labelElement = document.querySelector(`label[for="${id}"]`);
                let labelText = labelElement ? labelElement.textContent.replace('*','').trim() : id;
                 // Attempt to get better label from header if label is simple
                 const header = element.closest('.section-card')?.querySelector('.section-header h5');
                 if (header) {
                    labelText = header.textContent.trim();
                 }

                if (element && element.value.trim()) {
                    context += `${labelText}: ${element.value.trim()}\n`;
                }
            });
            return context.trim();
        }

        // --- OpenAI API Interaction ---
        async function getOpenAISuggestion(targetElementId, categoryLabel, button) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showToast('Proszę wprowadzić klucz API OpenAI.', 'warning');
                return;
            }

            const targetElement = document.getElementById(targetElementId);
            const originalButtonText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generowanie...';

            const context = gatherContext();
            const systemPrompt = "Jesteś business analitykiem tworzącym specyfikację rozwiązania. Użytkownik poda Ci nazwę kategorii/obszar który ty uzupełnisz na podstawie dostarczonych Ci innych informacji. Dobierz sugestię do tej kategorii zgodnie z załączonym kontekstem. Zwróć tylko i wyłącznie sugestię, bez dodatkowych komentarzy, przykładów lub kontekstu. Powinno być zwięźle.";
            const userPrompt = `Kategoria w dla której powinien utworzyć sugestie to: ${categoryLabel}\n\nKontekst:\n${context}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini", // Use the specified model
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        temperature: 0.7, // Adjust creativity as needed
                        max_tokens: 150 // Limit response length
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("OpenAI API Error:", errorData);
                    throw new Error(`Błąd API OpenAI: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
                }

                const data = await response.json();
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    const suggestion = data.choices[0].message.content.trim();
                    targetElement.value = suggestion;
                    showToast(`Sugestia dla "${categoryLabel}" wygenerowana pomyślnie.`, 'success');
                } else {
                    throw new Error('Nie otrzymano poprawnej odpowiedzi od API.');
                }

            } catch (error) {
                console.error('Błąd podczas pobierania sugestii AI:', error);
                showToast(`Nie udało się pobrać sugestii: ${error.message}`, 'danger');
            } finally {
                 button.disabled = false;
                 button.innerHTML = originalButtonText;
            }
        }

         // --- Test API Connection ---
        async function testOpenAIConnection() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showToast('Proszę wprowadzić klucz API OpenAI.', 'warning');
                apiStatusSpan.textContent = 'Brak klucza';
                apiStatusSpan.className = 'badge bg-warning text-dark';
                return;
            }

            apiStatusSpan.textContent = 'Testowanie...';
            apiStatusSpan.className = 'badge bg-info text-dark';
            testConnectionBtn.disabled = true;

             try {
                // Simple test: list models (low cost) or a very short completion
                const response = await fetch('https://api.openai.com/v1/models', { // Changed to models endpoint for a lighter test
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                 if (!response.ok) {
                    const errorData = await response.json().catch(() => ({})); // Catch JSON parse error if body is not JSON
                    throw new Error(`Błąd: ${response.status} ${response.statusText}. ${errorData.error?.message || 'Sprawdź klucz API i połączenie.'}`);
                 }

                // Check if response looks valid (optional, depends on endpoint)
                 const data = await response.json();
                 if (!data || !data.data) { // Check structure of models response
                    throw new Error('Otrzymano nieoczekiwaną odpowiedź od API.');
                 }

                apiStatusSpan.textContent = 'Połączono';
                apiStatusSpan.className = 'badge bg-success';
                showToast('Połączenie z API OpenAI pomyślne!', 'success');

            } catch (error) {
                console.error('Błąd testowania połączenia API:', error);
                apiStatusSpan.textContent = 'Błąd';
                apiStatusSpan.className = 'badge bg-danger';
                showToast(`Błąd połączenia: ${error.message}`, 'danger');
            } finally {
                 testConnectionBtn.disabled = false;
            }
        }

        // --- Save Canvas (JSON) ---
        function saveCanvasToJson() {
            if (!validateRequiredFields()) {
                return;
            }

            const canvasData = {};
            allInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    canvasData[id] = element.value;
                }
            });

            // Include API Key if needed (optional, usually not saved)
            // canvasData['openai-api-key'] = apiKeyInput.value;

            const jsonString = JSON.stringify(canvasData, null, 2); // Pretty print JSON
            const blob = new Blob([jsonString], { type: 'application/json' });
            saveAs(blob, 'canvas.data.json'); // From FileSaver.js
            showToast('Kanwa zapisana jako canvas.data.json', 'success');
        }

        // --- Load Canvas (JSON) ---
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const canvasData = JSON.parse(e.target.result);
                    allInputIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && canvasData.hasOwnProperty(id)) {
                            element.value = canvasData[id];
                            element.classList.remove('is-invalid'); // Clear validation state on load
                        }
                    });
                     // Load API key if it was saved (check if needed)
                    // if (canvasData['openai-api-key']) {
                    //    apiKeyInput.value = canvasData['openai-api-key'];
                    // }
                    showToast('Kanwa załadowana pomyślnie.', 'success');
                     // Reset file input value to allow loading the same file again
                     loadCanvasInput.value = null;
                } catch (error) {
                    console.error('Błąd podczas ładowania pliku JSON:', error);
                    showToast(`Nie udało się załadować pliku: ${error.message}`, 'danger');
                     loadCanvasInput.value = null;
                }
            };
            reader.onerror = function(e) {
                 console.error('Błąd odczytu pliku:', e);
                 showToast('Wystąpił błąd podczas odczytu pliku.', 'danger');
                 loadCanvasInput.value = null;
            }
            reader.readAsText(file);
        }

        // --- Save as DOCX ---
        function saveCanvasToDocx() {
             if (!validateRequiredFields()) {
                return;
            }

            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

            const sections = []; // Array to hold all paragraphs and headings

            // Helper to add section heading and content
            const addSection = (level, title, contentId, label) => {
                 sections.push(new Paragraph({ heading: level, children: [new TextRun(title)] }));
                 const element = document.getElementById(contentId);
                 const content = element ? element.value.trim() : 'Brak danych';
                 // Split content by newlines and create paragraphs
                 const lines = content.split('\n');
                 lines.forEach(line => {
                     if (line.trim()) { // Add non-empty lines
                        // Basic Markdown interpretation (Bold and Italic) - can be expanded
                        const children = [];
                        const parts = line.split(/(\*\*.*?\*\*|\*.*?\*)/g); // Split by bold/italic markers
                        parts.forEach(part => {
                            if (part.startsWith('**') && part.endsWith('**')) {
                                children.push(new TextRun({ text: part.slice(2, -2), bold: true }));
                            } else if (part.startsWith('*') && part.endsWith('*')) {
                                children.push(new TextRun({ text: part.slice(1, -1), italics: true }));
                            } else if (part) {
                                children.push(new TextRun(part));
                            }
                        });
                         sections.push(new Paragraph({ children: children.length > 0 ? children : [new TextRun(" ")] })); // Add space if line was just whitespace after split
                     }
                 });
                 sections.push(new Paragraph(" ")); // Add spacing between sections
            };

            const addSimpleField = (label, contentId) => {
                const element = document.getElementById(contentId);
                const content = element ? element.value.trim() : 'Brak danych';
                sections.push(new Paragraph({
                    children: [
                        new TextRun({ text: `${label}: `, bold: true }),
                        new TextRun(content)
                    ]
                }));
            };

             // --- Build Document Content ---
            sections.push(new Paragraph({ heading: HeadingLevel.HEADING_1, children: [new TextRun("AI Product Canvas")] }));
            sections.push(new Paragraph(" ")); // Spacing

            // 1. Definicja Rozwiązania
            sections.push(new Paragraph({ heading: HeadingLevel.HEADING_2, children: [new TextRun("1. Definicja Rozwiązania")] }));
            addSimpleField("Nazwa rozwiązania", "nazwa-rozwiazania");
            addSimpleField("Właściciel", "wlasciciel");
            addSection(HeadingLevel.HEADING_3, "Krótki opis rozwiązania", "krotki-opis");
            sections.push(new Paragraph(" "));

             // 2. Aspekty Biznesowe i Użytkownik
            sections.push(new Paragraph({ heading: HeadingLevel.HEADING_2, children: [new TextRun("2. Aspekty Biznesowe i Użytkownik")] }));
             // Problem i wartość biznesowa
            addSection(HeadingLevel.HEADING_3, "Problem biznesowy i oczekiwane rezultaty", "problem-biznesowy");
            addSection(HeadingLevel.HEADING_3, "Wartość biznesowa", "wartosc-biznesowa");
            addSection(HeadingLevel.HEADING_3, "Możliwe przeszkody", "mozliwe-przeszkody");
             // Dane
            addSection(HeadingLevel.HEADING_3, "Dostępność i źródła danych", "dostepnosc-danych");
             // Użytkownicy
            addSection(HeadingLevel.HEADING_3, "Grupy użytkowników i ich potrzeby", "uzytkownicy-potrzeby");
             // Działanie i mierniki
            addSection(HeadingLevel.HEADING_3, "Kluczowe funkcjonalności", "kluczowe-funkcjonalnosci");
            addSection(HeadingLevel.HEADING_3, "Mierniki sukcesu (KPI)", "mierniki-sukcesu");
            sections.push(new Paragraph(" "));

             // 3. Aspekty Technologiczne
            sections.push(new Paragraph({ heading: HeadingLevel.HEADING_2, children: [new TextRun("3. Aspekty Technologiczne")] }));
             // Dane i modele
            addSection(HeadingLevel.HEADING_3, "Modele AI i techniki", "modele-ai");
            addSection(HeadingLevel.HEADING_3, "Ocena i walidacja modeli", "ocena-modeli");
             // Infrastruktura i bezpieczeństwo
            addSection(HeadingLevel.HEADING_3, "Infrastruktura", "infrastruktura");
            addSection(HeadingLevel.HEADING_3, "Bezpieczeństwo i prywatność", "bezpieczenstwo");
             // UX
            addSection(HeadingLevel.HEADING_3, "Interfejs i interakcja", "interfejs-ux");
             // Rozwój
            addSection(HeadingLevel.HEADING_3, "Zespół i metodologia", "zespol-metodologia");
            addSection(HeadingLevel.HEADING_3, "Plan wdrożenia i utrzymania", "plan-wdrozenia");

            // --- Create and Save Document ---
            const doc = new Document({
                sections: [{
                    properties: {},
                    children: sections
                }]
            });

            Packer.toBlob(doc).then(blob => {
                saveAs(blob, "AI_Product_Canvas.docx");
                showToast('Dokument DOCX wygenerowany pomyślnie.', 'success');
            }).catch(error => {
                 console.error('Błąd podczas generowania DOCX:', error);
                 showToast('Nie udało się wygenerować pliku DOCX.', 'danger');
            });
        }


        // --- Event Listeners ---
        testConnectionBtn.addEventListener('click', testOpenAIConnection);
        saveCanvasBtn.addEventListener('click', saveCanvasToJson);
        saveDocxBtn.addEventListener('click', saveCanvasToDocx);

        // Trigger hidden file input when "Wczytaj Kanwe" is clicked
        loadCanvasBtn.addEventListener('click', () => {
            loadCanvasInput.click();
        });

        // Handle file selection for loading
        loadCanvasInput.addEventListener('change', handleFileLoad);

        // Add listeners to all suggestion buttons
        suggestionButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');
                const label = button.getAttribute('data-label');
                getOpenAISuggestion(targetId, label, button);
            });
        });

         // Add input event listeners to clear validation errors on typing
         allInputIds.forEach(id => {
             const element = document.getElementById(id);
             if (element) {
                 element.addEventListener('input', () => {
                     if (element.classList.contains('is-invalid')) {
                         element.classList.remove('is-invalid');
                     }
                 });
             }
         });

        // --- Initial Setup ---
        // (Optional: Load saved API key from localStorage if desired)
        // const savedApiKey = localStorage.getItem('openaiApiKey');
        // if (savedApiKey) {
        //    apiKeyInput.value = savedApiKey;
        //    testOpenAIConnection(); // Optionally test on load
        // }
        // apiKeyInput.addEventListener('change', () => {
        //    localStorage.setItem('openaiApiKey', apiKeyInput.value);
        // });

    </script>
</body>
</html>
